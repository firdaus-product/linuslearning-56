<!DOCTYPE html>
<html lang="ms-MY" class="overflow-hidden overscroll-none">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Matematik Ceria: Misi Detektif & Cabaran</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* --- 1. TEMA VISUAL (HIJAU KONSISTEN) --- */
    body {
      font-family: 'Fredoka', sans-serif;
      background-color: #f0fdf4;
      background-image: radial-gradient(#86efac 2px, transparent 2px);
      background-size: 30px 30px;
    }

    /* Card Container */
    .game-card {
      background: white;
      border: 4px solid #475569;
      box-shadow: 8px 8px 0px #00000020;
      border-radius: 1.5rem;
      /* min-height: 600px; REMOVED */
      position: relative;
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    /* Buttons 3D */
    .btn-3d {
      transition: all 0.1s;
      border-bottom-width: 6px;
      border-color: rgba(0, 0, 0, 0.2);
      transform: translateY(0);
      cursor: pointer;
      display: inline-block;
    }

    .btn-3d:active:not(:disabled) {
      transform: translateY(4px);
      border-bottom-width: 2px;
      box-shadow: none;
    }

    .btn-3d:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      border-bottom-width: 6px;
      filter: grayscale(100%);
    }

    /* Animation & Feedback */
    .shake {
      animation: shake 0.4s ease-in-out;
      border-color: #ef4444 !important;
      background-color: #fee2e2 !important;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-8px) rotate(-5deg);
      }

      75% {
        transform: translateX(8px) rotate(5deg);
      }
    }

    /* --- 2. STYLE KHUSUS AKTIVITI --- */

    /* Detektif */
    .story-token {
      background-color: #dcfce7;
      padding: 2px 10px;
      border-radius: 8px;
      cursor: pointer;
      border-bottom: 3px solid #22c55e;
      color: #15803d;
      transition: all 0.2s;
    }

    .story-token:hover {
      background-color: #bbf7d0;
      transform: scale(1.05);
    }

    .story-token.clicked {
      opacity: 0.5;
      text-decoration: line-through;
      cursor: default;
      border-bottom-width: 0;
      transform: translateY(3px);
    }

    .evidence-box {
      border: 3px dashed #94a3b8;
      border-radius: 0.75rem;
      padding: 0.5rem;
      text-align: center;
      font-weight: bold;
      background: #f8fafc;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .evidence-box.filled {
      background: #fff7ed;
      border-color: #f97316;
      color: #c2410c;
      border-style: solid;
    }

    /* Drag & Drop */
    .number-card {
      transition: all .3s;
      cursor: grab;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
      border-width: 3px;
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .number-card:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    .dragging {
      opacity: 0.5;
      transform: scale(0.9);
    }

    .drop-zone {
      border: 3px dashed #cbd5e1;
      background-color: #f1f5f9;
      transition: all .3s ease;
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: monospace;
      color: #cbd5e1;
    }

    .drop-zone.drag-over {
      border-color: #3b82f6;
      background-color: #dbeafe;
      transform: scale(1.05);
    }

    .drop-zone-filled {
      border: 3px solid #22c55e !important;
      background-color: #dcfce7 !important;
      color: #15803d !important;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
      font-family: 'Fredoka', sans-serif;
    }

    /* --- PEMBETULAN: GRID BENTUK LAZIM (AKTIVITI 3 & 4) --- */
    .bentuk-lazim {
      font-family: 'Fredoka', monospace;
      font-size: 1.5rem;
      width: fit-content;
      margin: 0 auto;
      text-align: right;
      position: relative;
      padding-left: 2rem;
      /* Ruang untuk simbol + */
    }

    .lazim-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 0.5rem;
      position: relative;
    }

    .lazim-col {
      width: 2.5rem;
      text-align: center;
      display: inline-block;
      height: 2.5rem;
      line-height: 2.5rem;
      border-radius: 0.5rem;
    }

    .lazim-col.active {
      background: #dbeafe;
      color: #1e40af;
      animation: popIn 0.3s;
    }

    @keyframes popIn {
      0% {
        transform: scale(0.5);
      }

      100% {
        transform: scale(1);
      }
    }

    .line {
      border-bottom: 6px solid #475569;
      margin: 0.5rem 0;
      border-radius: 3px;
    }

    .lazim-answer .lazim-col {
      opacity: 0;
      transition: opacity 0.5s;
      color: #166534;
      font-weight: bold;
      background: #dcfce7;
    }

    .lazim-answer .lazim-col.visible {
      opacity: 1;
    }

    /* --- PEMBETULAN: CARRY OVER & SIMBOL + --- */
    .carry-row {
      display: flex;
      justify-content: flex-end;
      height: 2rem;
      margin-bottom: 0px;
    }

    .carry-num {
      font-size: 1.5rem;
      color: #ef4444;
      font-weight: bold;
      opacity: 0;
      transition: all 0.5s ease;
      transform: translateY(10px);
    }

    .carry-num.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .symbol-plus {
      position: absolute;
      left: -60px;
      /* Tarik ke kiri */
      top: 5px;
      font-weight: bold;
      color: #475569;
      font-size: 3rem;
    }
  </style>
</head>

<body class="h-screen w-screen overflow-hidden text-slate-800 flex flex-col overscroll-none">

  <div class="flex-none p-4 z-50 pointer-events-none w-full">
    <div
      class="max-w-4xl mx-auto bg-green-400 border-4 border-green-600 rounded-full px-4 py-2 shadow-xl flex items-center justify-between pointer-events-auto transform hover:scale-[1.01] transition-transform">
      <div class="flex items-center gap-3">
        <span class="text-2xl animate-bounce">üöÄ</span>
        <span id="info-text" class="text-lg font-bold text-green-900 leading-none mt-1">Jom Belajar Tambah!</span>
      </div>
      <button id="speak-btn" onclick="speakInfo()"
        class="bg-white hover:bg-green-50 text-green-600 border-2 border-green-200 rounded-full p-2 transition-colors shadow-sm">üîä</button>
    </div>
  </div>
  <div class="h-4"></div>

  <div class="flex-1 w-full max-w-5xl mx-auto p-2 flex flex-col min-h-0">
    <div class="game-card p-4 mb-2 flex-1 w-full">
      <div id="activity-content" class="w-full h-full relative z-10 flex flex-col overflow-hidden">
        <div class="py-10 text-center flex flex-col justify-center h-full">
          <div class="text-6xl mb-4 animate-pulse">üíØ</div>
          <h2 class="text-3xl font-bold text-emerald-600 mb-2">Operasi Tambah</h2>
          <p class="text-lg text-slate-500 mb-4 font-semibold">Selesaikan misi-misi di bawah!</p>
          <div class="text-2xl animate-bounce">üëá</div>
        </div>
      </div>
    </div>

    <div class="flex-none bg-white/80 backdrop-blur-sm rounded-3xl shadow-lg p-2 border-2 border-white">
      <h3 class="text-lg font-bold text-slate-700 mb-2 text-center">üéÆ Pilih Misi</h3>
      <div class="grid grid-cols-5 gap-2 mb-2">
        <button onclick="loadActivity(1)"
          class="btn-3d bg-blue-500 text-white font-bold py-2 px-1 rounded-xl text-xs">üïµÔ∏è‚Äç‚ôÇÔ∏è<br>Detektif</button>
        <button onclick="loadActivity(2)"
          class="btn-3d bg-emerald-500 text-white font-bold py-2 px-1 rounded-xl text-xs">üìä<br>Susun</button>
        <button onclick="loadActivity(3)"
          class="btn-3d bg-violet-500 text-white font-bold py-2 px-1 rounded-xl text-xs">üß±<br>Blok</button>
        <button onclick="loadActivity(4)"
          class="btn-3d bg-orange-500 text-white font-bold py-2 px-1 rounded-xl text-xs">üß†<br>Cabaran</button>
        <button onclick="loadActivity(5)"
          class="btn-3d bg-rose-500 text-white font-bold py-2 px-1 rounded-xl text-xs">‚úçÔ∏è<br>Cerita</button>
      </div>
      <div class="flex justify-center gap-4 border-t-2 border-slate-100 pt-2">
        <button onclick="clearActivity()"
          class="btn-3d bg-slate-400 text-white font-bold py-1 px-4 rounded-full text-sm">üè† Menu</button>
        <button onclick="nextActivity()"
          class="btn-3d bg-indigo-500 text-white font-bold py-1 px-6 rounded-full text-base">Seterusnya ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <script>
    /* --- HELPERS --- */
    let currentActivity = 0;
    let ttsEnabled = false;
    let currentInfo = "Pilih aktiviti.";
    let draggedElement = null;

    function triggerWin() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } }); }

    function speak(text) {
      if (!ttsEnabled || !('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text); u.lang = 'ms-MY'; u.rate = 0.9; u.pitch = 1.1;
      const voices = window.speechSynthesis.getVoices();
      const ms = voices.find(v => v.lang === 'ms-MY' || v.lang?.startsWith('ms'));
      if (ms) u.voice = ms;
      window.speechSynthesis.speak(u);
    }
    function setInfo(text) {
      currentInfo = text;
      const infoEl = document.getElementById('info-text');
      infoEl.style.opacity = 0;
      setTimeout(() => { infoEl.textContent = text; infoEl.style.opacity = 1; }, 200);
    }
    function speakInfo() {
      if (!ttsEnabled) { ttsEnabled = true; document.getElementById('speak-btn').classList.add('bg-green-100', 'text-green-600'); }
      speak(currentInfo);
    }

    function dragStart(e) { draggedElement = e.target; e.target.classList.add('dragging'); }
    function dragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over')); }
    function allowDrop(e) { e.preventDefault(); if (e.currentTarget.classList.contains('drop-zone')) e.currentTarget.classList.add('drag-over'); }
    function dragLeave(e) { if (e.currentTarget.classList.contains('drop-zone')) e.currentTarget.classList.remove('drag-over'); }

    /* --- ROUTER --- */
    function loadActivity(n) {
      currentActivity = n;
      const content = document.getElementById('activity-content');
      content.style.opacity = 0;
      setTimeout(() => {
        content.innerHTML = '';
        if (n === 1) loadActivity1_Detective(content);
        if (n === 2) loadActivity2_Susun(content);
        if (n === 3) loadActivity3_BlokMudah(content);
        if (n === 4) loadActivity4_BlokCabaran(content);
        if (n === 5) loadActivity5_BinaCerita(content);
        content.style.opacity = 1;
      }, 200);
    }
    function clearActivity() {
      currentActivity = 0;
      document.getElementById('activity-content').innerHTML = `<div class="py-10 text-center flex flex-col justify-center h-full"><div class="text-6xl mb-4 animate-bounce">üíØ</div><h2 class="text-3xl font-bold text-emerald-600 mb-2">Operasi Tambah</h2><p class="text-lg text-slate-500 mb-4 font-semibold">Pilih misi di bawah!</p></div>`;
      setInfo("Pilih misi.");
    }
    function nextActivity() { let next = currentActivity + 1; if (next > 5) next = 1; loadActivity(next); }

    /* =========================================
       AKTIVITI 1: Detektif
       ========================================= */
    function loadActivity1_Detective(content) {
      setInfo("Klik pada nombor dalam cerita.");
      let state = { box1: null, box2: null, box3: null, answer: null, count: 0 };

      content.innerHTML = `
        <h3 class="text-xl font-bold text-blue-500 mb-2 text-center flex-none">üïµÔ∏è‚Äç‚ôÇÔ∏è Detektif Cerita</h3>
        <div class="flex-1 w-full overflow-y-auto px-4 flex flex-col">
            <div class="bg-blue-50 p-4 rounded-3xl border-4 border-blue-200 mb-4 text-lg leading-relaxed text-slate-700 shadow-sm text-center flex-none">
              Upin ada <span class="story-token" data-value="250" data-target="box1">250</span> biji guli. 
              Ipin pula ada <span class="story-token" data-value="148" data-target="box2">148</span> biji guli. 
              Berapakah <span class="story-token" data-value="+" data-target="box3">jumlah</span> guli mereka?
            </div>
            <div class="grid grid-cols-3 gap-2 mb-4 w-full flex-none">
              <div id="box1" class="evidence-box text-slate-400">Nombor 1</div>
              <div id="box3" class="evidence-box text-slate-400">Operasi</div>
              <div id="box2" class="evidence-box text-slate-400">Nombor 2</div>
            </div>
            <div id="math-sentence" class="text-2xl font-black text-center text-slate-700 h-10 mb-2 flex-none"></div>
            <div id="answer-section" class="hidden text-center bg-white p-4 rounded-3xl shadow-lg border-2 border-slate-100 flex-col w-full max-w-sm mx-auto flex-none">
               <div class="flex items-center justify-center gap-2">
                   <input type="text" inputmode="numeric" id="detective-answer-input" class="lazim-input w-32 h-10 text-xl" placeholder="?" style="width: 120px;">
                   <button id="detective-check-btn" class="btn-3d bg-emerald-500 text-white font-bold py-2 px-4 rounded-xl text-lg">Semak</button>
               </div>
               <div id="detective-feedback" class="mt-2 text-lg font-bold h-6"></div>
            </div>
        </div>
      `;

      content.querySelectorAll('.story-token').forEach(token => {
        token.addEventListener('click', () => {
          if (token.classList.contains('clicked')) return;
          const val = token.dataset.value;
          const target = document.getElementById(token.dataset.target);
          target.textContent = val; target.classList.add('filled'); token.classList.add('clicked');
          state[token.dataset.target] = val; state.count++;

          if (state.count === 3) {
            state.answer = parseInt(state.box1) + parseInt(state.box2);
            document.getElementById('math-sentence').innerHTML = `<span class="animate-pulse bg-slate-100 px-4 py-2 rounded-xl border-2 border-slate-300">${state.box1} ${state.box3} ${state.box2} = ?</span>`;
            document.getElementById('answer-section').classList.remove('hidden');
            setInfo("Kira jawapannya.");
            document.getElementById('detective-check-btn').onclick = () => {
              const inp = document.getElementById('detective-answer-input');
              const fb = document.getElementById('detective-feedback');
              if (parseInt(inp.value) === state.answer) {
                fb.textContent = "Tepat! 398"; fb.className = "mt-4 text-xl font-bold text-emerald-600";
                inp.disabled = true; document.getElementById('detective-check-btn').disabled = true;
                triggerWin(); setInfo("Tahniah!");
              } else {
                fb.textContent = "Cuba lagi..."; fb.className = "mt-4 text-xl font-bold text-rose-500";
                inp.classList.add('shake'); setTimeout(() => inp.classList.remove('shake'), 500);
              }
            };
          }
        });
      });
    }

    /* =========================================
       AKTIVITI 2: Susun Nombor
       ========================================= */
    function loadActivity2_Susun(content) {
      setInfo("Seret digit ke petak yang betul.");
      const digits = [2, 5, 0, 1, 4, 8];
      content.innerHTML = `
        <h3 class="text-xl font-bold text-emerald-500 mb-2 text-center flex-none">üìä Susun Nombor</h3>
        <div class="flex-1 w-full overflow-y-auto p-2 flex flex-col items-center">
            <div class="text-center text-lg font-bold text-slate-500 mb-2 flex-none">Soalan: <span class="bg-white px-2 py-1 rounded-lg border-2 border-slate-200">250 + 148</span></div>
            <div class="flex flex-col items-center justify-center gap-2 w-full flex-none">
               <div class="bg-white p-4 rounded-3xl border-4 border-slate-300 shadow-md">
                  <div class="flex justify-end gap-2 mb-1 font-bold text-slate-400 text-xs px-2"><span>Ra</span><span>Pu</span><span>Sa</span></div>
                  <div class="flex justify-end gap-1 mb-1">
                     <div class="drop-zone w-10 h-10 text-xl" data-correct="2" ondrop="dropOnSusun(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">?</div>
                     <div class="drop-zone w-10 h-10 text-xl" data-correct="5" ondrop="dropOnSusun(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">?</div>
                     <div class="drop-zone w-10 h-10 text-xl" data-correct="0" ondrop="dropOnSusun(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">?</div>
                  </div>
                  <div class="flex items-center justify-end gap-1">
                     <div class="text-2xl font-bold text-slate-400 mr-1">+</div>
                     <div class="drop-zone w-10 h-10 text-xl" data-correct="1" ondrop="dropOnSusun(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">?</div>
                     <div class="drop-zone w-10 h-10 text-xl" data-correct="4" ondrop="dropOnSusun(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">?</div>
                     <div class="drop-zone w-10 h-10 text-xl" data-correct="8" ondrop="dropOnSusun(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">?</div>
                  </div>
                  <div class="border-b-4 border-slate-600 my-2 rounded-full"></div>
               </div>
               <div class="bg-emerald-50 p-2 rounded-3xl border-4 border-emerald-200 w-full max-w-xs">
                  <h4 class="text-center font-bold text-emerald-700 mb-2 text-sm">Pilihan Digit</h4>
                  <div id="digit-basket" class="flex flex-wrap justify-center gap-2">
                     ${digits.sort(() => Math.random() - 0.5).map(d => `
                        <div class="number-card bg-white border-emerald-400 text-emerald-700 w-10 h-10 text-xl font-bold"
                             draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" data-digit="${d}">${d}</div>
                     `).join('')}
                  </div>
               </div>
            </div>
        </div>
      `;
    }
    function dropOnSusun(e) {
      e.preventDefault(); e.currentTarget.classList.remove('drag-over');
      if (!draggedElement) return;
      const val = draggedElement.dataset.digit;
      if (val === e.currentTarget.dataset.correct) {
        e.currentTarget.classList.remove('shake'); e.currentTarget.textContent = val;
        e.currentTarget.classList.remove('drop-zone'); e.currentTarget.classList.add('drop-zone-filled');
        e.currentTarget.removeAttribute('ondrop'); draggedElement.remove(); draggedElement = null;
        if (document.querySelectorAll('#digit-basket div').length === 0) { setInfo("Syabas!"); triggerWin(); }
        else { setInfo(`Betul! ${val} diletak.`); }
      } else { setInfo("Salah tempat."); e.currentTarget.classList.add('shake'); setTimeout(() => { if (!e.currentTarget.classList.contains('drop-zone-filled')) e.currentTarget.classList.remove('shake'); }, 500); }
    }

    /* =========================================
       AKTIVITI 3: Blok Mudah
       ========================================= */
    function loadActivity3_BlokMudah(content) {
      setInfo("Kira 250 + 148.");
      content.innerHTML = `
        <h3 class="text-xl font-bold text-violet-500 mb-2 text-center flex-none">üß± Blok Mudah</h3>
        <div class="flex-1 w-full overflow-y-auto flex flex-col items-center">
            <div class="flex justify-center mb-4 flex-none">
                <div class="bg-white p-4 rounded-3xl border-4 border-violet-200 shadow-md inline-block pr-6 pl-6">
                   <div class="bentuk-lazim">
                      <div class="lazim-row text-slate-400 text-base font-bold mb-1">
                         <span class="lazim-col">Ra</span><span class="lazim-col">Pu</span><span class="lazim-col">Sa</span>
                      </div>
                      <div class="lazim-row"><span class="lazim-col" id="c-r1">2</span><span class="lazim-col" id="c-p1">5</span><span class="lazim-col active" id="c-s1">0</span></div>
                      <div class="lazim-row">
                         <div class="symbol-plus" style="font-size: 2rem; left: -2rem;">+</div>
                         <span class="lazim-col" id="c-r2">1</span><span class="lazim-col" id="c-p2">4</span><span class="lazim-col active" id="c-s2">8</span>
                      </div>
                      <div class="line"></div>
                      <div class="lazim-answer lazim-row">
                         <span class="lazim-col" id="ans-r">3</span><span class="lazim-col" id="ans-p">9</span><span class="lazim-col" id="ans-s">8</span>
                      </div>
                   </div>
                </div>
            </div>
            <div id="block-info" class="bg-violet-50 p-2 rounded-2xl text-center text-base font-bold text-violet-800 mb-2 min-h-[60px] flex items-center justify-center border-2 border-violet-100 mx-auto w-full max-w-sm flex-none">
                Sa (0 + 8): 0 blok Sa + 8 blok Sa = 8 blok Sa.
            </div>
            <div class="flex justify-center gap-2 flex-none">
               <button id="btn1" class="btn-3d bg-violet-500 text-white font-bold py-2 px-4 rounded-xl text-sm" onclick="stepMagic(1)">1. Kira Sa</button>
               <button id="btn2" class="btn-3d bg-slate-300 text-white font-bold py-2 px-4 rounded-xl text-sm" disabled onclick="stepMagic(2)">2. Kira Pu</button>
               <button id="btn3" class="btn-3d bg-slate-300 text-white font-bold py-2 px-4 rounded-xl text-sm" disabled onclick="stepMagic(3)">3. Kira Ra</button>
            </div>
        </div>
      `;
    }
    function stepMagic(step) {
      const info = document.getElementById('block-info');
      document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
      if (step === 1) {
        document.getElementById('ans-s').classList.add('visible');
        info.textContent = "Puluh (5 + 4): 5 blok Puluh + 4 blok Puluh = 9 blok Puluh.";
        document.getElementById('btn1').disabled = true;
        document.getElementById('btn2').disabled = false; document.getElementById('btn2').classList.replace('bg-slate-300', 'bg-violet-500');
        ['c-p1', 'c-p2'].forEach(id => document.getElementById(id).classList.add('active'));
        setInfo("Kira rumah 'Puluh'.");
      } else if (step === 2) {
        document.getElementById('ans-p').classList.add('visible');
        info.textContent = "Ratus (2 + 1): 2 blok Ratus + 1 blok Ratus = 3 blok Ratus.";
        document.getElementById('btn2').disabled = true;
        document.getElementById('btn3').disabled = false; document.getElementById('btn3').classList.replace('bg-slate-300', 'bg-violet-500');
        ['c-r1', 'c-r2'].forEach(id => document.getElementById(id).classList.add('active'));
        setInfo("Kira rumah 'Ratus'.");
      } else {
        document.getElementById('ans-r').classList.add('visible');
        info.innerHTML = "Jawapan penuh ialah <strong>398</strong>.";
        document.getElementById('btn3').disabled = true;
        setInfo("Syabas! Jawapan 398."); triggerWin();
      }
    }

    /* =========================================
       AKTIVITI 4: Cabaran Kumpul Semula (FIXED)
       ========================================= */
    function loadActivity4_BlokCabaran(content) {
      setInfo("Kira 124 + 42 + 173. Perhatikan kumpul semula.");
      content.innerHTML = `
        <h3 class="text-xl font-bold text-orange-500 mb-2 text-center flex-none">üß† Cabaran Kumpul Semula</h3>
        <div class="flex-1 w-full overflow-y-auto flex flex-col items-center">
            <div class="flex justify-center mb-4 flex-none">
                <div class="bg-white p-4 rounded-3xl border-4 border-orange-200 shadow-md inline-block pr-6 pl-6">
                   <div class="bentuk-lazim">
                      <div class="carry-row">
                          <span class="lazim-col carry-num" id="cr-r">1</span> 
                          <span class="lazim-col carry-num" id="cr-p"></span>
                          <span class="lazim-col"></span>
                      </div>
                      <div class="lazim-row"><span class="lazim-col">1</span><span class="lazim-col">2</span><span class="lazim-col active">4</span></div>
                      <div class="lazim-row"><span class="lazim-col">0</span><span class="lazim-col">4</span><span class="lazim-col active">2</span></div>
                      <div class="lazim-row">
                          <div class="symbol-plus" style="font-size: 2rem; left: -2rem;">+</div>
                          <span class="lazim-col">1</span><span class="lazim-col">7</span><span class="lazim-col active">3</span>
                      </div>
                      <div class="line"></div>
                      <div class="lazim-answer lazim-row">
                          <span class="lazim-col" id="a-r">3</span><span class="lazim-col" id="a-p">3</span><span class="lazim-col" id="a-s">9</span>
                      </div>
                   </div>
                </div>
            </div>
            <div id="c-info" class="bg-orange-50 p-2 rounded-2xl text-center text-base font-bold text-orange-800 mb-2 min-h-[80px] flex items-center justify-center border-2 border-orange-100 mx-auto w-full max-w-sm flex-none">
                Kira lajur Sa: 4 + 2 + 3 = ?
            </div>
            <div class="flex justify-center gap-2 flex-none">
               <button id="b1" class="btn-3d bg-orange-500 text-white font-bold py-2 px-4 rounded-xl text-sm" onclick="stepHard(1)">1. Kira Sa</button>
               <button id="b2" class="btn-3d bg-slate-300 text-white font-bold py-2 px-4 rounded-xl text-sm" disabled onclick="stepHard(2)">2. Kira Pu</button>
               <button id="b3" class="btn-3d bg-slate-300 text-white font-bold py-2 px-4 rounded-xl text-sm" disabled onclick="stepHard(3)">3. Kira Ra</button>
            </div>
        </div>
      `;
    }

    function stepHard(step) {
      const info = document.getElementById('c-info');
      document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));

      if (step === 1) {
        document.getElementById('a-s').classList.add('visible');
        info.innerHTML = "Rumah 'Pu' (2 + 4 + 7) = 13.<br>Nombor 13 tak muat! Kumpul semula 1 ke Ratus.";
        document.getElementById('b1').disabled = true;
        document.getElementById('b2').disabled = false; document.getElementById('b2').classList.replace('bg-slate-300', 'bg-orange-500');
        setInfo("Kira rumah 'Puluh'.");
      } else if (step === 2) {
        document.getElementById('a-p').classList.add('visible');
        document.getElementById('cr-r').classList.add('visible');
        info.innerHTML = "Rumah 'Ra' ((+1) + 1 + 0 + 1) = 3.<br>Sekarang kira semua di 'Ratus'.";
        document.getElementById('b2').disabled = true;
        document.getElementById('b3').disabled = false; document.getElementById('b3').classList.replace('bg-slate-300', 'bg-orange-500');
        setInfo("1 dibawa ke atas. Kira rumah 'Ratus'.");
      } else {
        document.getElementById('a-r').classList.add('visible');
        info.textContent = "Siap! Jawapan penuh ialah 339.";
        document.getElementById('b3').disabled = true; triggerWin();
        setInfo("Syabas! Jawapan 339.");
      }
    }

    /* =========================================
       AKTIVITI 5: Bina Cerita
       ========================================= */
    function loadActivity5_BinaCerita(content) {
      setInfo("Bina cerita sendiri!");
      const names = ["Upin", "Ipin", "Raju", "Mei Mei", "Ehsan", "Fizi"];
      const items = ["guli", "buku", "epal", "pensel", "pemadam"];
      const nums = [10, 15, 23, 31, 42, 50, 64, 75, 80, 91];
      const r1 = names[Math.floor(Math.random() * names.length)];
      const r2 = names.filter(n => n !== r1)[0];

      content.innerHTML = `
        <h3 class="text-xl font-bold text-rose-500 mb-2 text-center flex-none">‚úçÔ∏è Bina Cerita</h3>
        <div class="flex-1 w-full overflow-y-auto px-2 flex flex-col items-center">
            <div class="bg-white p-4 rounded-3xl border-4 border-rose-200 shadow-sm max-w-lg mx-auto text-lg leading-loose text-center flex-none w-full">
               <div class="flex flex-wrap items-center gap-2 justify-center mb-2">
                  <select id="s-n1" class="p-1 rounded-lg border-2 border-rose-200 font-bold text-rose-600 bg-rose-50 outline-none text-base">
                      ${names.map(n => `<option ${n === r1 ? 'selected' : ''}>${n}</option>`).join('')}
                  </select>
                  <span>ada</span>
                  <select id="s-v1" class="p-1 rounded-lg border-2 border-rose-200 font-bold text-rose-600 bg-rose-50 outline-none text-base">
                      ${nums.map(n => `<option>${n}</option>`).join('')}
                  </select>
                  <span>biji</span>
                  <select id="s-i" class="p-1 rounded-lg border-2 border-rose-200 font-bold text-rose-600 bg-rose-50 outline-none text-base">
                      ${items.map(n => `<option>${n}</option>`).join('')}
                  </select>.
               </div>
               <div class="flex flex-wrap items-center gap-2 justify-center">
                  <select id="s-n2" class="p-1 rounded-lg border-2 border-rose-200 font-bold text-rose-600 bg-rose-50 outline-none text-base">
                      ${names.map(n => `<option ${n === r2 ? 'selected' : ''}>${n}</option>`).join('')}
                  </select>
                  <span>pula ada</span>
                  <select id="s-v2" class="p-1 rounded-lg border-2 border-rose-200 font-bold text-rose-600 bg-rose-50 outline-none text-base">
                      ${nums.reverse().map(n => `<option>${n}</option>`).join('')}
                  </select>
                  <span>biji lagi.</span>
               </div>
            </div>
            <div class="text-center mt-4 flex-none">
               <button class="btn-3d bg-rose-500 text-white font-bold py-2 px-6 rounded-xl text-lg" onclick="storyCalc()">Jana & Kira! üßÆ</button>
            </div>
            <div id="story-res" class="text-center mt-4 text-2xl font-black text-rose-800 min-h-[50px] flex-none"></div>
        </div>
      `;

      window.storyCalc = function () {
        const v1 = parseInt(document.getElementById('s-v1').value);
        const v2 = parseInt(document.getElementById('s-v2').value);
        const item = document.getElementById('s-i').value;
        const total = v1 + v2;
        const msg = `Jumlah ${item} ialah ${total} biji.`;
        document.getElementById('story-res').innerHTML = `<span class="bg-rose-100 px-6 py-3 rounded-2xl border-2 border-rose-300 animate-bounce inline-block">${v1} + ${v2} = ${total}</span>`;
        setInfo(msg); triggerWin();
      }
    }
  </script>
</body>

</html>